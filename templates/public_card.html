{% extends "base.html" %}

{% block title %}{{ card.full_name if card else 'Visiting Card' }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<style>
.public-card-wrapper {
    max-width: 500px;
    margin: 40px auto;
    padding: 20px;
}

.public-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 40px;
    color: white;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    text-align: center;
}

.public-card-logo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 20px;
    border: 4px solid rgba(255,255,255,0.3);
    display: block;
}

.public-card-name {
    font-size: 28px;
    margin: 10px 0;
    font-weight: 700;
}

.public-card-title {
    font-size: 16px;
    opacity: 0.9;
    margin: 5px 0 20px;
}

.contact-details {
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
    padding: 25px;
    margin: 20px 0;
    text-align: left;
}

.contact-item {
    display: flex;
    align-items: center;
    margin: 12px 0;
    font-size: 14px;
}

.contact-item svg {
    margin-right: 12px;
    flex-shrink: 0;
}

.contact-item a {
    color: white;
    text-decoration: none;
    word-break: break-all;
}

.contact-item a:hover {
    text-decoration: underline;
}

.action-buttons {
    margin-top: 25px;
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-save-contact {
    background: white;
    color: #667eea;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
    font-size: 14px;
}

.btn-save-contact:hover {
    transform: scale(1.05);
}

.card-not-found {
    text-align: center;
    padding: 60px 20px;
}

.card-bio {
    margin: 20px 0;
    padding: 20px;
    background: rgba(255,255,255,0.1);
    border-radius: 15px;
    font-size: 14px;
    line-height: 1.6;
    text-align: left;
}
</style>
{% endblock %}

{% block content %}
<div class="public-card-wrapper">
    {% if card %}
    <div class="public-card">
        <img src="{{ card.profile_image_url or 'https://via.placeholder.com/120' }}" alt="{{ card.full_name }}" class="public-card-logo">

        <h1 class="public-card-name">{{ card.full_name }}</h1>
        {% if card.job_title %}
        <p class="public-card-title">{{ card.job_title }}{% if card.company %} at {{ card.company }}{% endif %}</p>
        {% endif %}

        {% if card.bio %}
        <div class="card-bio">
            {{ card.bio }}
        </div>
        {% endif %}

        <div class="contact-details">
            {% if card.email %}
            <div class="contact-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                    <polyline points="22,6 12,13 2,6"></polyline>
                </svg>
                <a href="mailto:{{ card.email }}">{{ card.email }}</a>
            </div>
            {% endif %}

            {% if card.phone %}
            <div class="contact-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
                <a href="tel:{{ card.phone }}">{{ card.phone }}</a>
            </div>
            {% endif %}

            {% if card.website %}
            <div class="contact-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
                <a href="{{ card.website }}" target="_blank">{{ card.website }}</a>
            </div>
            {% endif %}

            {% if card.address %}
            <div class="contact-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span>{{ card.address }}</span>
            </div>
            {% endif %}

            {% if card.instagram %}
            <div class="contact-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                    <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                </svg>
                <a href="https://instagram.com/{{ card.instagram }}" target="_blank">@{{ card.instagram }}</a>
            </div>
            {% endif %}

            {% if card.facebook %}
            <div class="contact-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path>
                </svg>
                <a href="https://facebook.com/{{ card.facebook }}" target="_blank">{{ card.facebook }}</a>
            </div>
            {% endif %}
        </div>

        <div class="action-buttons">
            <button id="saveContactBtn" class="btn-save-contact">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 8px; vertical-align: middle;">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
                Save to Contacts
            </button>
        </div>
    </div>
    {% else %}
    <div class="card-not-found">
        <h2>Card Not Found</h2>
        <p>The visiting card you're looking for doesn't exist or has been removed.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if card %}
<script>
// Build vCard data for download
function buildVCard() {
    const card = {{ card | tojson }};
    const lines = [];
    lines.push('BEGIN:VCARD');
    lines.push('VERSION:3.0');

    if (card.full_name) {
        lines.push(`FN:${card.full_name}`);
        const parts = card.full_name.trim().split(/\s+/);
        const family = parts.length > 1 ? parts.pop() : '';
        const given = parts.join(' ');
        lines.push(`N:${family};${given};;;`);
    }

    if (card.phone) lines.push(`TEL;TYPE=CELL:${card.phone}`);
    if (card.email) lines.push(`EMAIL:${card.email}`);
    if (card.company) lines.push(`ORG:${card.company}`);
    if (card.job_title) lines.push(`TITLE:${card.job_title}`);
    if (card.website) lines.push(`URL:${card.website}`);
    if (card.address) lines.push(`ADR:;;${card.address};;;;`);
    if (card.bio) lines.push(`NOTE:${card.bio.replace(/\r?\n/g, ' ')}`);

    lines.push('END:VCARD');
    return lines.join('\r\n');
}

document.getElementById('saveContactBtn').addEventListener('click', () => {
    const vCardData = buildVCard();
    const blob = new Blob([vCardData], { type: 'text/vcard;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = '{{ card.full_name }}.vcf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
});
</script>
{% endif %}
{% endblock %}
